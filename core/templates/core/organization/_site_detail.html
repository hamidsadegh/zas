{% if oob %}<div class="card" id="site-detail" hx-swap-oob="true">{% endif %}
<div class="section-title">
    <div>
        <h3>{{ site.name }}</h3>
        <div class="muted">{{ site.description|default:"No description provided." }}</div>
    </div>
    <span class="chip subtle">Site</span>
</div>

{% if not areas_exist %}
    <div class="notice">No areas created for this site. Add the first area below.</div>
    <form
        method="post"
        hx-post="{% url 'organization_area_create' %}"
        hx-target="#site-detail"
        hx-swap="innerHTML"
        class="stacked spacing-top"
    >
        {% csrf_token %}
        <input type="hidden" name="site_id" value="{{ site.id }}">
        <label class="muted" for="id_root_area_name">New area</label>
        <input id="id_root_area_name" name="name" class="input" required placeholder="Area name">
        <textarea name="description" class="textarea" placeholder="Description (optional)"></textarea>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Create Area</button>
        </div>
    </form>
{% else %}
    <div class="org-grid">
        <div class="area-panel">
            <div class="section-title">
                <h4>Areas</h4>
                <span class="chip subtle">{{ area_tree|length }} roots</span>
            </div>
            <div class="area-tree">
                {% include "core/organization/_area_tree.html" with nodes=area_tree site=site selected_area=selected_area %}
            </div>
            <script>
            (() => {
                document.querySelectorAll(".area-toggle").forEach(btn => {
                    if (btn.classList.contains("placeholder")) return;
                    btn.addEventListener("click", () => {
                        const li = btn.closest(".area-node");
                        if (!li) return;
                        const children = li.querySelector(":scope > .area-children");
                        if (children) {
                            const isOpen = li.classList.toggle("open");
                            children.style.display = isOpen ? "block" : "none";
                            const caret = btn.querySelector(".caret");
                            if (caret) caret.textContent = isOpen ? "▼" : "▶";
                            btn.setAttribute("aria-expanded", isOpen ? "true" : "false");
                        }
                    });
                });
            })();
            </script>
        </div>

        <div class="stacked">
            {% if error %}
                <div class="notice error">{{ error }}</div>
            {% endif %}
            {% if selected_area %}
            <div class="section-title">
                <div>
                    <h4>Area: {{ selected_area.name }}</h4>
                    <div class="muted">{{ selected_area.description|default:"No description" }}</div>
                </div>
                <span class="chip subtle">Area</span>
            </div>
            <div class="stacked card">
                <h4 class="section-heading">Rename area</h4>
                <form
                    method="post"
                    hx-post="{% url 'organization_area_update' selected_area.id %}"
                    hx-target="#site-detail"
                    hx-swap="innerHTML"
                    class="stacked"
                >
                    {% csrf_token %}
                    <input type="hidden" name="site_id" value="{{ site.id }}">
                    <input id="id_area_name" name="name" class="input" value="{{ area_form.name.value|default:selected_area.name }}" required>
                    <textarea name="description" class="textarea">{{ area_form.description.value|default:selected_area.description }}</textarea>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button
                            type="button"
                            class="btn btn-danger small"
                            hx-post="{% url 'organization_area_delete' selected_area.id %}"
                            hx-confirm="Delete area '{{ selected_area.name }}'?"
                            hx-target="#site-detail"
                            hx-swap="innerHTML"
                        >Delete</button>
                    </div>
                </form>
            </div>

            <div class="stacked card">
                <h4 class="section-heading">Add child area to: {{ selected_area.name }}</h4>
                <form
                    method="post"
                    hx-post="{% url 'organization_area_create' %}"
                    hx-target="#site-detail"
                    hx-swap="innerHTML"
                    class="stacked"
                >
                    {% csrf_token %}
                    <input type="hidden" name="site_id" value="{{ site.id }}">
                    <input type="hidden" name="parent_id" value="{{ selected_area.id }}">
                    <input name="name" class="input" placeholder="Child area name" required>
                    <textarea name="description" class="textarea" placeholder="Description (optional)"></textarea>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>

            <div class="stacked card">
                <div class="section-title">
                    <h4>Racks</h4>
                    <span class="chip subtle">{{ racks|length }}</span>
                </div>
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Height (U)</th>
                                <th>Description</th>
                                <th class="actions text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rack in racks %}
                            {% if rack_edit and rack_edit.id == rack.id %}
                            <tr>
                                <td colspan="4">
                                    <form
                                        method="post"
                                        hx-post="{% url 'organization_rack_update' rack.id %}"
                                        hx-target="#site-detail"
                                        hx-swap="innerHTML"
                                        class="stacked"
                                    >
                                        {% csrf_token %}
                                        <input type="hidden" name="area_id" value="{{ selected_area.id }}">
                                        <input name="name" class="input" value="{{ rack.name }}" required>
                                        <input type="number" name="u_height" class="input" value="{{ rack.u_height }}" min="1">
                                        <textarea name="description" class="textarea" placeholder="Description (optional)">{{ rack.description }}</textarea>
                                        <div class="form-actions end">
                                            <button type="submit" class="btn btn-primary">Save</button>
                                            <button
                                                type="button"
                                                class="btn btn-ghost"
                                                hx-get="{% url 'organization_site_detail' site.id %}?area={{ selected_area.id }}"
                                                hx-target="#site-detail"
                                                hx-swap="innerHTML"
                                            >Cancel</button>
                                        </div>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td>{{ rack.name }}</td>
                                <td>{{ rack.u_height }}</td>
                                <td>{{ rack.description|default:"" }}</td>
                                <td class="actions">
                                    <div class="table-actions">
                                        <a class="btn btn-ghost small" href="{% url 'organization_rack_detail' rack.id %}">View</a>
                                        <button
                                            type="button"
                                            class="btn btn-ghost small"
                                            hx-get="{% url 'organization_home' %}?site={{ site.id }}&area={{ selected_area.id }}&rack={{ rack.id }}"
                                            hx-target="#organization-page"
                                            hx-swap="outerHTML"
                                            hx-push-url="true"
                                        >Edit</button>
                                        <form
                                            method="post"
                                            hx-post="{% url 'organization_rack_delete' rack.id %}"
                                            hx-target="#site-detail"
                                            hx-swap="innerHTML"
                                            hx-confirm="Delete rack '{{ rack.name }}'?"
                                        >
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger small">Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% empty %}
                            <tr>
                                <td colspan="4" class="muted">No racks yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="stacked section-spacer">
                    <h4 class="section-heading">Add rack</h4>
                    <form
                        method="post"
                        hx-post="{% url 'organization_rack_create' %}"
                        hx-target="#site-detail"
                        hx-swap="innerHTML"
                        class="stacked"
                    >
                        {% csrf_token %}
                        <input type="hidden" name="area_id" value="{{ selected_area.id }}">
                        <input name="name" class="input" placeholder="Rack name" required>
                        <input type="number" name="u_height" class="input" placeholder="Height (U)" min="1">
                        <textarea name="description" class="textarea" placeholder="Description (optional)"></textarea>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Create Rack</button>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
                <div class="notice">Select an area from the tree to manage racks.</div>
            {% endif %}
        </div>
    </div>
{% endif %}
{% if oob %}</div>{% endif %}
