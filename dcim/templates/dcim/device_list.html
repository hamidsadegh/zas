{% extends "core/base.html" %}

{% block title %}Devices{% endblock %}

{% block styles %}
{% include "dcim/_layout_styles.html" %}
.devices-wrapper { padding: 1.5rem 2rem; font-size: 0.95rem; }
.list-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
.list-header h1 { margin: 0; font-size: 1.5rem; }
.list-controls { display: flex; align-items: center; gap: 0.5rem; margin-left: auto; }
.filters { display: flex; align-items: center; gap: 0.5rem; flex-wrap: nowrap; justify-content: flex-end; }
.filters select { min-width: 120px; flex: 0 0 auto; }
.filters input[type="text"] { min-width: 260px; flex: 1 1 260px; }
.quick-filter-toggle {
    width: 2rem;
    height: 2rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fff;
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
.quick-filter-toggle:hover { color: var(--text); border-color: #cbd5e1; }
.quick-filter-toggle.is-active { color: #fff; background: var(--primary); border-color: var(--primary); }
.quick-filter-toggle svg { width: 1rem; height: 1rem; }
.hidden-submit {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}
.device-table { font-size: 0.9rem; }
.device-table thead th { padding: 0.6rem 0.8rem; }
.quick-filter-row th { padding-top: 0.2rem; padding-bottom: 0.35rem; }
.quick-filter-input {
    width: 100%;
    max-width: 180px;
    min-width: 0;
    padding: 0.08rem 0.28rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: #fff;
    color: var(--text);
    font-size: 0.68rem;
    line-height: 1.05;
    height: 1.25rem;
}
.quick-filter-input::placeholder { color: var(--muted); }
.device-table tr { border-bottom: 1px solid var(--border); }
.device-table td { padding: 0.75rem 0.8rem; border-bottom: none; }
.device-table tbody tr:last-child { border-bottom: none; }
.device-name { font-weight: 600; display: block; margin-bottom: 0.1rem; }
.device-meta { color: var(--muted); font-size: 0.75rem; }
.status-pill { padding: 0.2rem 0.8rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; display: inline-flex; align-items: center; justify-content: center; }
.status-active { background: #def7ec; color: #03543f; }
.status-inactive { background: #e5e7eb; color: #374151; }
.status-maintenance { background: #fef3c7; color: #92400e; }
.status-unknown { background: #f3f4f6; color: #4b5563; }
.reachability { display: inline-flex; gap: 0.35rem; align-items: center; }
.reachability-dot { width: 0.65rem; height: 0.65rem; border-radius: 50%; display: inline-block; border: 1px solid var(--border); box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2); }
.reachability-dot.ok { background: #22c55e; border-color: #16a34a; box-shadow: 0 0 6px rgba(34, 197, 94, 0.45); }
.reachability-dot.fail { background: #ef4444; border-color: #dc2626; box-shadow: 0 0 6px rgba(239, 68, 68, 0.45); }
.reachability-dot.disabled { background: #d1d5db; border-color: #c4c9d4; box-shadow: none; opacity: 0.6; }
.table-actions a { padding: 0.35rem 0.9rem; }
@media (max-width: 1200px) {
    .devices-wrapper { padding: 1.25rem; }
    .device-table { font-size: 0.8rem; }
    .device-table th,
    .device-table td { padding: 0.6rem; }
}
{% endblock %}

{% block content %}
<section class="devices-wrapper">
    <div class="list-header">
        <div>
            <p class="tag">Inventory</p>
            <h1>Devices</h1>
        </div>
        <div class="list-controls">
            <form method="get" class="filters" id="device-list-filters">
                <select name="site" onchange="this.form.submit()">
                    {% for key, label in site_choices %}
                        <option value="{{ key }}" {% if site_filter == key %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                {% if tag_choices %}
                <select name="tag" onchange="this.form.submit()">
                    <option value="">All tags</option>
                    {% for tag in tag_choices %}
                        <option value="{{ tag.id }}" {% if tag_filter|stringformat:"s" == tag.id|stringformat:"s" %}selected{% endif %}>{{ tag.name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                <input type="text" name="search" value="{{ search_query }}" placeholder="Search devices…">
                <select name="paginate_by" onchange="this.form.submit()">
                    {% for option in per_page_options %}
                        <option value="{{ option }}" {% if paginate_by == option %}selected{% endif %}>Show {{ option }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="sort" value="{{ sort_field }}">
                {% if interface_status_filter %}
                    <input type="hidden" name="interface_status" value="{{ interface_status_filter }}">
                {% endif %}
                <button type="submit" class="hidden-submit" aria-hidden="true" tabindex="-1">Apply</button>
            </form>
            <button
                id="device-quick-filter-toggle"
                class="quick-filter-toggle"
                type="button"
                aria-label="Show or hide quick filters"
                aria-expanded="false"
                title="Show quick filters">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z"></path>
                </svg>
            </button>
        </div>
    </div>

    <div class="table-scroll">
        <table
            class="device-table"
            data-quick-filter-table
            data-quick-filter-mode="server"
            data-quick-filter-debounce="500"
            data-quick-filter-toggle-id="device-quick-filter-toggle"
            data-quick-filter-visible="0">
            <thead>
                <tr>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'name' %}-name{% elif sort_field == '-name' %}name{% else %}name{% endif %}">Device</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'management_ip' %}-management_ip{% elif sort_field == '-management_ip' %}management_ip{% else %}management_ip{% endif %}">IP</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'reachability' %}-reachability{% elif sort_field == '-reachability' %}reachability{% else %}reachability{% endif %}">Reachability</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'status' %}-status{% elif sort_field == '-status' %}status{% else %}status{% endif %}">Status</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'device_type__model' %}-device_type__model{% elif sort_field == '-device_type__model' %}device_type__model{% else %}device_type__model{% endif %}">Type</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'serial_number' %}-serial_number{% elif sort_field == '-serial_number' %}serial_number{% else %}serial_number{% endif %}">Serial</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'area__name' %}-area__name{% elif sort_field == '-area__name' %}area__name{% else %}area__name{% endif %}">Location</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'rack__name' %}-rack__name{% elif sort_field == '-rack__name' %}rack__name{% else %}rack__name{% endif %}">Rack</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'site__name' %}-site__name{% elif sort_field == '-site__name' %}site__name{% else %}site__name{% endif %}">Site</a></th>
                <th class="nowrap"><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}paginate_by={{ paginate_by }}&sort={% if sort_field == 'image_version' %}-image_version{% elif sort_field == '-image_version' %}image_version{% else %}image_version{% endif %}">Image</a></th>
                <th></th>
            </tr>
            <tr class="quick-filter-row">
                <th><input class="quick-filter-input" type="text" name="qf_device" form="device-list-filters" value="{{ quick_filter_values.qf_device }}" data-quick-filter-col="0" placeholder="Filter device"></th>
                <th><input class="quick-filter-input" type="text" name="qf_ip" form="device-list-filters" value="{{ quick_filter_values.qf_ip }}" data-quick-filter-col="1" placeholder="Filter IP"></th>
                <th></th>
                <th></th>
                <th><input class="quick-filter-input" type="text" name="qf_type" form="device-list-filters" value="{{ quick_filter_values.qf_type }}" data-quick-filter-col="4" placeholder="Filter type"></th>
                <th><input class="quick-filter-input" type="text" name="qf_serial" form="device-list-filters" value="{{ quick_filter_values.qf_serial }}" data-quick-filter-col="5" placeholder="Filter serial"></th>
                <th><input class="quick-filter-input" type="text" name="qf_location" form="device-list-filters" value="{{ quick_filter_values.qf_location }}" data-quick-filter-col="6" placeholder="Filter location"></th>
                <th><input class="quick-filter-input" type="text" name="qf_rack" form="device-list-filters" value="{{ quick_filter_values.qf_rack }}" data-quick-filter-col="7" placeholder="Filter rack"></th>
                <th></th>
                <th><input class="quick-filter-input" type="text" name="qf_image" form="device-list-filters" value="{{ quick_filter_values.qf_image }}" data-quick-filter-col="9" placeholder="Filter image"></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
                <tr>
                    <td>
                        <a class="device-name" href="{% url 'device_detail' device.id %}">{{ device.name }}</a>
                    </td>
                    <td>{{ device.management_ip }}</td>
                    <td>
                        <div class="reachability">
                            {% with ping_enabled=reachability_checks.ping %}
                            <span class="reachability-dot {% if not ping_enabled %}disabled{% elif device.runtime.reachable_ping %}ok{% else %}fail{% endif %}"
                                  title="Ping"
                                  aria-label="Ping"></span>
                            {% endwith %}
                            {% with ssh_enabled=reachability_checks.ssh %}
                            <span class="reachability-dot {% if not ssh_enabled %}disabled{% elif device.runtime.reachable_ssh %}ok{% else %}fail{% endif %}"
                                  title="SSH"
                                  aria-label="SSH"></span>
                            {% endwith %}
                            {% with snmp_enabled=reachability_checks.snmp %}
                            <span class="reachability-dot {% if not snmp_enabled %}disabled{% elif device.runtime.reachable_snmp %}ok{% else %}fail{% endif %}"
                                  title="SNMP"
                                  aria-label="SNMP"></span>
                            {% endwith %}
                            {% with netconf_enabled=reachability_checks.netconf %}
                            <span class="reachability-dot {% if not netconf_enabled %}disabled{% elif device.runtime.reachable_netconf %}ok{% else %}fail{% endif %}"
                                  title="Netconf"
                                  aria-label="Netconf"></span>
                            {% endwith %}
                        </div>
                    </td>
                    <td>
                        <span class="status-pill status-{{ device.status|default:'unknown' }}">
                            {{ device.status|default:"unknown" }}
                        </span>
                    </td>
                    <td>{{ device.device_type|default:"—" }}</td>
                    <td>{{ device.serial_number|default:"—" }}</td>
                    <td>{{ device.area|default:"—" }}</td>
                    <td>{{ device.rack.name|default:"—" }}</td>
                <td>{{ device.site.name|default:"—" }}</td>
                <td class="nowrap">{{ device.image_version|default:"—" }}</td>
                <td class="table-actions nowrap">
                    <a class="btn btn-ghost small" href="{% url 'device_detail' device.id %}">View</a>
                </td>
            </tr>
            {% empty %}
                <tr>
                    <td colspan="11" style="text-align: center; padding: 2rem; color: var(--muted);">
                        No devices found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-wrapper">
        <div class="range-info">
            {% if page_obj %}
                Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }} devices
            {% else %}
                Showing {{ devices|length }} devices
            {% endif %}
        </div>
        {% if page_obj %}
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li>
                    <a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}{% if sort_field %}sort={{ sort_field }}&{% endif %}{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
            {% else %}
                <li><span>Previous</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="active"><span>{{ num }}</span></li>
                {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                    <li>
                        <a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}{% if sort_field %}sort={{ sort_field }}&{% endif %}{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li>
                    <a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if tag_filter %}tag={{ tag_filter|urlencode }}&{% endif %}{% if sort_field %}sort={{ sort_field }}&{% endif %}{% if interface_status_filter %}interface_status={{ interface_status_filter|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&page={{ page_obj.next_page_number }}">Next</a>
                </li>
            {% else %}
                <li><span>Next</span></li>
            {% endif %}
        </ul>
        {% endif %}
    </div>
</section>
{% include "dcim/_table_quick_filters_script.html" %}
{% endblock %}
