{% extends "base.html" %}

{% block title %}Devices{% endblock %}

{% block styles %}
.devices-wrapper {
    width: 95%;
    margin: 0 auto;
    background: var(--surface);
    border-radius: 22px;
    padding: 1.5rem 2rem;
    box-shadow: var(--shadow);
    font-size: 0.85rem; /* ~13.6px on base 16 */
}

.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}

.list-header h1 {
    margin: 0;
    font-size: 1.5rem;
}

.filters {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex-wrap: wrap;
}

.filters input,
.filters select {
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 0.4rem 0.9rem;
    font-size: 0.85rem;
    min-width: 170px;
}

.filters button {
    border-radius: 999px;
    border: none;
    padding: 0.4rem 1.2rem;
    font-weight: 600;
    font-size: 0.9rem;
    background: var(--primary);
    color: #fff;
    box-shadow: var(--shadow);
}

.device-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.device-table thead th {
    text-align: left;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.7rem;
    color: var(--muted);
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid var(--border);
}

.device-table tbody tr {
    border-bottom: 1px solid var(--border);
}

.device-table tbody tr:last-child {
    border-bottom: none;
}

.device-table td {
    padding: 0.75rem 0.8rem;
    vertical-align: middle;
}

.device-name {
    font-weight: 600;
    display: block;
    margin-bottom: 0.1rem;
}

.device-meta {
    color: var(--muted);
    font-size: 0.75rem;
}

.status-pill {
    padding: 0.2rem 0.8rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: capitalize;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.status-active { background: #def7ec; color: #03543f; }
.status-inactive { background: #e5e7eb; color: #374151; }
.status-maintenance { background: #fef3c7; color: #92400e; }
.status-unknown { background: #f3f4f6; color: #4b5563; }

.reachability {
    display: inline-flex;
    gap: 0.35rem;
    align-items: center;
}

.reachability-dot {
    width: 0.65rem;
    height: 0.65rem;
    border-radius: 50%;
    display: inline-block;
    border: 1px solid var(--border);
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
}

.reachability-dot.ok {
    background: #22c55e;
    border-color: #16a34a;
    box-shadow: 0 0 6px rgba(34, 197, 94, 0.45);
}

.reachability-dot.fail {
    background: #ef4444;
    border-color: #dc2626;
    box-shadow: 0 0 6px rgba(239, 68, 68, 0.45);
}

.reachability-dot.disabled {
    background: #d1d5db;
    border-color: #c4c9d4;
    box-shadow: none;
    opacity: 0.6;
}

.table-actions a {
    border-radius: 999px;
    border: 1px solid var(--border);
    padding: 0.35rem 0.9rem;
    font-weight: 600;
    font-size: 0.8rem;
}

.pagination-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.8rem;
}

.range-info {
    color: var(--muted);
}

.pagination {
    list-style: none;
    display: flex;
    gap: 0.3rem;
    margin: 0;
    padding: 0;
}

.pagination a,
.pagination span {
    border-radius: 8px;
    padding: 0.3rem 0.8rem;
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 0.8rem;
}

.pagination .active span {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
}

main {
    max-width: none;
    width: 95vw;
    margin: 0 auto;
}

@media (max-width: 1200px) {
    .devices-wrapper {
        width: 95%;
        padding: 1.25rem;
    }

    .device-table {
        font-size: 0.8rem;
    }

    .device-table th,
    .device-table td {
        padding: 0.6rem;
    }
}
{% endblock %}

{% block content %}
<section class="devices-wrapper">
    <div class="list-header">
        <div>
            <p class="tag">Inventory</p>
            <h1>Devices</h1>
        </div>
        <form method="get" class="filters">
            <select name="site" onchange="this.form.submit()">
                {% for key, label in site_choices %}
                    <option value="{{ key }}" {% if site_filter == key %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <input type="text" name="search" value="{{ search_query }}" placeholder="Search devices…">
            <select name="paginate_by" onchange="this.form.submit()">
                {% for option in per_page_options %}
                    <option value="{{ option }}" {% if paginate_by == option %}selected{% endif %}>Show {{ option }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="sort" value="{{ sort_field }}">
            <button type="submit">Search</button>
        </form>
    </div>

    <table class="device-table">
        <thead>
            <tr>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=name">Device</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=management_ip">IP</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=management_ip"></a>Reachability</th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=status">Status</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=device_type__model">Type</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=serial_number">Serial</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=area__name">Location</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=rack__name">Rack</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=site">Site</a></th>
                <th><a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&sort=image_version">Image</a></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td>
                    <a class="device-name" href="{% url 'device_detail' device.id %}">{{ device.name }}</a>
                    <span class="device-meta">{{ device.vendor|default:"Unknown vendor" }}</span>
                </td>
                <td>{{ device.management_ip }}</td>
                <td>
                    <div class="reachability">
                        {% with ping_enabled=reachability_checks.ping %}
                        <span class="reachability-dot {% if not ping_enabled %}disabled{% elif device.reachable_ping %}ok{% else %}fail{% endif %}"
                              title="{% if ping_enabled %}Ping reachable{% else %}Ping check disabled{% endif %}"
                              aria-label="{% if ping_enabled %}Ping reachable: {% if device.reachable_ping %}yes{% else %}no{% endif %}{% else %}Ping check disabled{% endif %}"></span>
                        {% endwith %}
                        {% with snmp_enabled=reachability_checks.snmp %}
                        <span class="reachability-dot {% if not snmp_enabled %}disabled{% elif device.reachable_snmp %}ok{% else %}fail{% endif %}"
                              title="{% if snmp_enabled %}SNMP reachable{% else %}SNMP check disabled{% endif %}"
                              aria-label="{% if snmp_enabled %}SNMP reachable: {% if device.reachable_snmp %}yes{% else %}no{% endif %}{% else %}SNMP check disabled{% endif %}"></span>
                        {% endwith %}
                        {% with ssh_enabled=reachability_checks.ssh %}
                        <span class="reachability-dot {% if not ssh_enabled %}disabled{% elif device.reachable_ssh %}ok{% else %}fail{% endif %}"
                              title="{% if ssh_enabled %}SSH reachable{% else %}SSH check disabled{% endif %}"
                              aria-label="{% if ssh_enabled %}SSH reachable: {% if device.reachable_ssh %}yes{% else %}no{% endif %}{% else %}SSH check disabled{% endif %}"></span>
                        {% endwith %}
                        {% with telemetry_enabled=reachability_checks.telemetry %}
                        <span class="reachability-dot {% if not telemetry_enabled %}disabled{% elif device.reachable_telemetry %}ok{% else %}fail{% endif %}"
                              title="{% if telemetry_enabled %}Telemetry reachable{% else %}Telemetry check disabled{% endif %}"
                              aria-label="{% if telemetry_enabled %}Telemetry reachable: {% if device.reachable_telemetry %}yes{% else %}no{% endif %}{% else %}Telemetry check disabled{% endif %}"></span>
                        {% endwith %}
                    </div>
                </td>
                <td>
                    <span class="status-pill status-{{ device.status|default:'unknown' }}">
                        {{ device.status|default:"unknown" }}
                    </span>
                </td>
                <td>{{ device.device_type|default:"—" }}</td>
                <td>{{ device.serial_number|default:"—" }}</td>
                <td>{{ device.area|default:"—" }}</td>
                <td>{{ device.rack.name|default:"—" }}</td>
                <td>{{ device.site }}</td>
                <td>{{ device.image_version|default:"—" }}</td>
                <td class="table-actions">
                    <a href="{% url 'device_detail' device.id %}">View</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="11" style="text-align: center; padding: 2rem; color: var(--muted);">
                    No devices found.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination-wrapper">
        <div class="range-info">
            {% if page_obj %}
                Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }} devices
            {% else %}
                Showing {{ devices|length }} devices
            {% endif %}
        </div>
        {% if page_obj %}
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li>
                    <a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if sort_field %}sort={{ sort_field }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
            {% else %}
                <li><span>Previous</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="active"><span>{{ num }}</span></li>
                {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                    <li>
                        <a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if sort_field %}sort={{ sort_field }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li>
                    <a href="?{% if search_query %}search={{ search_query|urlencode }}&{% endif %}{% if sort_field %}sort={{ sort_field }}&{% endif %}site={{ site_filter|urlencode }}&paginate_by={{ paginate_by }}&page={{ page_obj.next_page_number }}">Next</a>
                </li>
            {% else %}
                <li><span>Next</span></li>
            {% endif %}
        </ul>
        {% endif %}
    </div>
</section>
{% endblock %}
